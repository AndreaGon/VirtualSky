<!DOCTYPE html>
<html>
<head>
	<title>Virtual Sky</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes" />
	<!--
		Virtual Sky <canvas> application
		(c) 2010-2012 Stuart Lowe (Las Cumbras Observatory Global Telescope)
	-->
	<style>
	html,body { height: 100%; overflow-y: hidden; }
	body {
		font-family: Helvetica, sans-serif;
		color: black;
		margin: 0px;
		padding: 0px;
		height: 100%;
		width: 100%;
		font-size: 1em;
	}
	#starmapper { height: 100%; width:100%; position: relative; }
	#virtualskyinfobox{
		font-size: 12px;
		display:none;
		background-color:rgba(200,200,200,1);
		color:black;
		padding:5px;
		max-width:150px;
		border-radius:0.5em;
		-moz-border-radius: 0.5em;
		-webkit-border-radius: 0.5em;
		box-shadow:0px 0px 20px rgba(255,255,255,0.5);
		-moz-box-shadow:0px 0px 20px rgba(255,255,255,0.5);
		-webkit-box-shadow:0px 0px 20px rgba(255,255,255,0.5);
	}
	.virtualskyinfocredit{
		font-size:0.5em;
		float:left;
		position:absolute;
		padding:5px;
		color: white;
	}
	#virtualskyinfobox img { width: 128px; height: 128px; }
	</style>
	<!-- IE seems to get very confused if it loads Javascript from within a Javascript when in an iframe. We'll have to load it here -->
	<!--[if IE]><script src="excanvas.min.js"></script><![endif]-->
	<script src="stuquery.js"></script>
	<script>
		//jQuery = S;
		//$ = jQuery;
	</script>
	<script src="virtualsky.js" type="text/javascript"></script>
	<script>
		function geoIP(){
			if(S('#'+this.id+'_geoip').length == 0){
				var eg = "e.g. Cardiff, UK";
				S('#'+this.id+'_geo').append('<div style="text-align:center;margin-top:4px;"><form id="'+this.id+'_geoip"><input id="'+this.id+'_location" value="'+eg+'" style="width:12em;"> <input id="'+this.id+'_geoip_btn" type="submit" value="Search" /><br /><span id="'+this.id+'_geoip_message"><\/span><\/form><\/div>');
				this.lightbox.resize();
				// Store current state of the keyboard variable
				// When we're in the input field, we don't want to change the sky
				S('#'+this.id+'_location').on('focus',{sky:this},function(e){
					e.data.sky.keyboard = false;
					if(S('#'+e.data.sky.id+'_location').val() == eg) S('#'+e.data.sky.id+'_location').val('');
				}).on('blur',{sky:this,key:this.keyboard},function(e){
					e.data.sky.keyboard = e.data.key;
					if(!S('#'+e.data.sky.id+'_location').val()){
						S('#'+e.data.sky.id+'_location').val(eg);
						S('#'+e.data.sky.id+'_geoip_message').html('');
						e.data.sky.createLightbox(S('#'+e.data.sky.id+'_geo'));
					}
				});
				S('#'+this.id+'_geoip').on('submit',{sky:this},function(e){
					e.preventDefault();
					if(S('#'+e.data.sky.id+'_location').val() == eg){
						S('#'+e.data.sky.id+'_geoip_message').html('You need to enter a place to search for.');
						return false;
					}
					var _object = e.data.sky;
					S('#'+e.data.sky.id+'_geoip_message').html('Trying to identify location...')
					loc = escape(S('#'+e.data.sky.id+'_location').val());
					S(document).ajax('http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20geo.places%20where%20text%3D%22'+loc+'%22&format=json&diagnostics=true',{
						dataType: "json", 
						this: _object,
						success: function(data){
							failed = false;
							if(data.query.results && typeof data.query.results.place=="object"){
								place = data.query.results.place;
								S('#'+this.id+'_geoip_message').html('');
								if(place.length > 1){
									var str = '<form><select><option value="-1">Select...<\/option>';
									S('#'+this.id+'_geoip_message').html();
									for(i = 0; i < place.length ; i++){
										str += '<option value="'+i+'">'+place[i].name+', '+place[i].admin1.content+', '+place[i].country.content+'<\/option>';
									}
									str += '<\/select><\/form>';
									S('#'+this.id+'_geoip_message').append(str);
									S('#'+this.id+'_geoip_message select').on('change',{sky:this,place:place},function(e){
										var i = S(this)[0].value;
										if(i >= 0){
											var sky = e.data.sky;
											sky.latitude = parseFloat(e.data.place[i].centroid.latitude);
											sky.longitude = parseFloat(e.data.place[i].centroid.longitude);
											S('#'+sky.id+'_lat').val(sky.latitude);
											S('#'+sky.id+'_long').val(sky.longitude);
											sky.draw();
											sky.setClock(0);
										}
									});
								}else{
									if(data.query.results.place.centroid){
										lat = data.query.results.place.centroid.latitude;
										lon = data.query.results.place.centroid.longitude;
										place = data.query.results.place.placeTypeName.content+' in '+data.query.results.place.country.content
										this.latitude = parseFloat(lat);
										this.longitude = parseFloat(lon);
										S('#'+this.id+'_lat').val(this.latitude);
										S('#'+this.id+'_long').val(this.longitude);
										S('#'+this.id+'_geoip_message').html(place);
										this.draw();
										this.setClock(0);
									}else{
										failed = true;
									}
								}
							}else failed = true;
							if(failed){
								S('#'+this.id+'_geoip_message').html('Failed to find the location');
							}
						}
					});
				});
			}
		}
		S(document).ready(function(){
			planetarium = S.virtualsky({id:'starmapper',callback:{geo:geoIP},fullscreen:true});
		});
	</script>
</head>

<body>
<div id="starmapper"></div>
</body>
</html>
